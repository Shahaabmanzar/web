<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Kiwix Mobile Download Page</title>
<link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/css/bootstrap-combined.min.css" rel="stylesheet">
<link href="http://code.jquery.com/mobile/1.3.0/jquery.mobile-1.3.0.min.css" rel="stylesheet">
<style>
div#loadingBox {
	position: fixed;
	bottom: 12px;
	right: 12px;
	font-family: Arial, Helvetica, Sans-Serif;
	font-size: 12px;
	background-color: #000000;
	color: #FFFFFF;
	padding: 6px;
	display: none;
}
</style>
</head>
<body>

	<div class="container">
<header>
	<h2>Download content for Kiwix</h2>
	<!-- <p><span class="help-block">Choose whithin Wikipedia, Ubuntu, Wikileaks, etc.</span></p> -->
	<p><label for="languageselector">Language:</label></p>
	<p><select id="languageselector">
	</select></p>

	<p><label>Download method:</label></p>
	<p><select id="downloadmethodselector">
	    <option value="http" selected="selected">HTTP (easier, can be slow)</option>
	    <option value="bittorrent">Bittorrent (faster, requires a torrent client)</option>
	</select></p>
</header>

<p><legend>Available downloads</legend></p>
<ul id="list" class="nav nav-tabs nav-stacked">
	<li class="active">Please, filter out the contents you want to be presented to…</li>
</ul>

<div id="chunkalert" class="alert">
	<p>If your ZIM file weights more than 4GB, you might encouter difficulties to copy it to your SD card. It's a known limitation of the FAT32 file system. To fix that problem, you can either reformat your SD card using NTFS or split the ZIM file in chunks using one of the following software:</p>
	<ul>
		<li> On Microsoft Windows: <a rel="nofollow" class="external text" href="http://www.jaist.ac.jp/~hoangle/filesj/">FSJ-Lite</a></li>
		<li> On Apple Mac OSX: <a rel="nofollow" class="external text" href="http://loekjehe.home.xs4all.nl/Split&amp;Concat/">Split&amp;Concat</a></li>
		<li> On GNU/Linux and with the console: <code>split --bytes=4000M my_big_file.zim</code></li>
	</ul>
	<p>The splitted ZIM files must be named xxx.zimaa, xxx.zimab, xxx.zimac, etc.</p>
</div>

<div id="results">
</div>

</div>
<script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
<script src="http://code.jquery.com/mobile/1.3.0/jquery.mobile-1.3.0.min.js"></script>
<script src="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/js/bootstrap.min.js"></script>
<script type="text/javascript">

var all_link = $('<li><a href="http://www.kiwix.org/wiki/Special:MyLanguage/Wikipedia_in_all_languages">→ List of Wikipedia downloads in all languages…</a></li>');

function showLoading() {
    $('#results').append('<div id="loadingBox">Loading...</div>');
}

function load_content() {
	var language_code = ($("#languageselector").val()==null)?(navigator.language || navigator.userLanguage).substring(0,2):($("#languageselector").val());
	
	//var url ='/wiki/Special:Mylanguage/Wikipedia/'+language_code;
	var url ='/wiki/Template:ZIMdumps';
	// DEBUG OONLY
	// url = 'http://kiwix.org' + url;

	//clean language selector
	$("#languageselector").html('');
	
	//clean results (loading text too)
	$('#results').empty();
	$('#list').empty();
	$('#results').load(url + ' #zimtable', function() {

		// change link to all archives
		var all_a_elem = $('#zimtable tr:last-child a:last-child');
		var all_url = all_a_elem.attr('href');
		all_url = 'http://www.kiwix.org' + all_url;
		all_a_elem.attr('href', all_url);

		// remove md5 link
		$('#zimtable a').each(function () {
			if ($(this).attr('href').indexOf('.md5') != -1) {
				$(this).parent().parent().remove();
			}
		});

		// download bitorrent ; are there torrent clients on android?
		$('#zimtable a').each(function () {
			if ($(this).attr('href').indexOf('.torrent') != -1) {
				$(this).parent().remove();
			}
		});

		$('#zimtable tr:not(:last-child) th:last-child').remove();
		$('#zimtable tr:not(:last-child) td:last-child').remove();


		//
		// loop on each row and rebuild the table for easier reading on mobile
		//

		// remove last row (link to all)
		try {
			all_a_elem.parent().parent().parent().remove();
		} catch (e) {alert(e);}
		// remove first row (headers)
		$('#zimtable tr:first-child').remove();

		$('#zimtable tr:visible').each(function (){
			var zim_lang_code = $(this).children('td:first-child').html();
			zim_lang_code = $.trim(zim_lang_code);
			var zim_lang_name = $(this).children('td:gt(0)').html();
			var zim_size = $(this).children('td:gt(1)').html();
			var zim_date = $(this).children('td:gt(2)').html();
			var zim_articles = $(this).children('td:gt(3)').html();
			var zim_link = $($(this).children('td:gt(4)').html());
			var zim_link_href = zim_link.attr('href');

			var dl_method = $("#downloadmethodselector").val();
			if (dl_method == 'bittorrent') {
				zim_link_href += '.torrent';
			}
			var zim_link_name = zim_link.val();
			
			//show results for language selected
			if (zim_lang_code==language_code) {
				li = $('<li><a href="' + zim_link_href + '"><strong>' + zim_lang_name + ' Wikipedia (' + zim_lang_code + ')</strong>: ' + zim_date + '<br/>Articles: ' + zim_articles + ' - ' + zim_size + 'GB</a></li>')
				$('ul#list').append(li);
			}
			
			//making the languague selector from table
			$("#languageselector").append('<option value="'+zim_lang_code+'">'+zim_lang_name+'</option>');
		});
		//var all_li = $('<li></li>').append(all_a_elem)
		//$('ul#list').append(all_li)

		$('#results').empty();
		$('ul#list').append(all_link);
		
		//loading base on browser agent language
                $("#languageselector option[value="+language_code+"]").attr("selected", "selected");
                $('#languageselector').selectmenu('refresh',true);
		//hideLoading();
	});

	//Show message Loading	
	showLoading();
	
}


$(document).ready(function() {
	$('ul#list').append(all_link);
	$("#downloadmethodselector").change(load_content);
	$("#languageselector").change(load_content);
	load_content();
	
});
</script>
</html>
